# conductor

指揮者スキル - Do Phaseの状況を判断し、適切なエージェントを選択・実行する

## トリガー

- `evaluate` スキルでユーザー承認後
- Do Phase開始時
- `/conductor` コマンド実行時

## 目的

TODOリストを自律的に実行するため、状況に応じて適切なエージェント（実装/検証/レビュー）を選択し、タスクを完了まで導く

---

## 入力

- 承認済みTODOリスト
- 現在のタスク状態

## 出力

- タスク完了報告
- （失敗時）エスカレーション報告

---

## エージェント構成

```
       ┌────────────────────────┐
       │      conductor         │
       │   （状況判断・選択）    │
       └──────────┬─────────────┘
                  │
      ┌───────────┼───────────┐
      ↓           ↓           ↓
┌──────────┐ ┌──────────┐ ┌──────────┐
│implementer│ │ validator │ │ reviewer │
│  （実装） │ │  （検証） │ │（レビュー）│
└──────────┘ └──────────┘ └──────────┘
```

---

## 判断ロジック

### 標準フロー

```
開始
  ↓
実装 (implementer)
  ↓
検証 (validator)
  ↓
レビュー (reviewer)
  ↓
完了
```

### 失敗時のフロー

```
検証失敗 → 実装へ戻る
レビューNG → 実装へ戻る
```

### 状態遷移表

| 現在の状態 | 条件 | 次のエージェント |
|------------|------|------------------|
| 開始 | - | implementer |
| 実装完了 | - | validator |
| 検証成功 | - | reviewer |
| 検証失敗 | 失敗回数 < 3 | implementer |
| 検証失敗 | 失敗回数 >= 3 | エスカレーション |
| レビューOK | - | 次タスク or 完了 |
| レビューNG | 失敗回数 < 3 | implementer |
| レビューNG | 失敗回数 >= 3 | エスカレーション |

---

## 処理フロー

### 1. タスク選択

TODOリストから次に実行するタスクを選択：
- 依存関係が解決済み
- 未完了
- 優先順位が高い

### 2. エージェント実行

状態に応じて適切なエージェントを呼び出す：

```
現在のタスク: タスク1
状態: 未着手
→ implementer を実行
```

### 3. 結果の評価

エージェントの実行結果を評価：
- 成功 → 次の状態へ
- 失敗 → リトライまたはエスカレーション

### 4. ループ継続

全タスク完了まで2-3を繰り返す

---

## エスカレーション

### 条件

- 同一タスクで **3回連続失敗**
- 解決不能なエラー発生
- 想定外の状況

### エスカレーション時の報告

```markdown
## エスカレーション報告

### 状況

タスク「[タスク名]」で3回連続失敗しました。

### 試行履歴

1. [1回目の試行内容と失敗理由]
2. [2回目の試行内容と失敗理由]
3. [3回目の試行内容と失敗理由]

### 推定原因

[原因の分析]

### 提案

- A: [解決案A]
- B: [解決案B]
- C: タスクをスキップ

ご指示をお願いします。
```

---

## 状態管理

### タスク状態

```typescript
interface TaskState {
  id: string;
  status: 'pending' | 'in_progress' | 'completed' | 'failed';
  currentPhase: 'implement' | 'validate' | 'review';
  failureCount: number;
  history: HistoryEntry[];
}
```

### 履歴記録

各エージェント実行の結果を記録：
- 実行エージェント
- 実行結果（成功/失敗）
- 変更内容
- エラー詳細（失敗時）

---

## 完了条件

全タスクについて以下が満たされた場合：

- [x] implementer による実装完了
- [x] validator による検証通過
- [x] reviewer による承認

---

## 次のスキル

タスク状態に応じて：
- 実装が必要 → `implementer`
- 検証が必要 → `validator`
- レビューが必要 → `reviewer`
- 全完了 → ユーザーに最終報告
