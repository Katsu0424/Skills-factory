---
name: bug-investigation
description: |
  アラートやエラーログから原因箇所と修正案を特定する。
  「調査して」「原因は？」「なぜ落ちた？」などログを貼り付けて依頼された時に使用。
  構造化ログ、スタックトレース、Sentryアラート等に対応。
allowed-tools: Read, Grep, Glob
---

# バグ調査スキル

## 呼び出し方
会話でログを貼り付けて「調査して」「原因は？」「なぜ落ちた？」等

## 目的
アラートやエラーログを渡すだけで原因箇所と修正案を特定

---

## フロー

```
ログ入力 → エラー抽出 → 関連コード特定 → 原因推定 → 修正案提示
```

---

## 対応ログ形式

### 1. 構造化ログ（JSON）
```json
{"level":"error","msg":"connection refused","trace":"..."}
```

### 2. Rustパニック
```
thread 'main' panicked at 'index out of bounds', src/main.rs:42:5
stack backtrace:
   0: std::panicking::begin_panic
   ...
```

### 3. 一般的なスタックトレース
```
Error: Something went wrong
    at functionName (file.js:123:45)
    at anotherFunction (file.js:67:12)
```

### 4. Sentryアラート
- EventID
- スタックトレース
- breadcrumbs
- タグ・コンテキスト情報

### 5. その他
- アプリケーションログ
- システムログ
- HTTPエラーレスポンス

---

## 調査ステップ

1. **ログ解析**: エラーメッセージ、スタックトレースを抽出
2. **コード特定**: ファイルパス、行番号から該当コードを取得
3. **コンテキスト収集**: 周辺コード、呼び出し元を確認
4. **原因推定**: エラーパターンと実装を照合
5. **修正案生成**: 具体的なコード変更を提案
6. **類似検索**: 同じパターンの他箇所をgrep

---

## 出力形式

```markdown
## エラー概要
（エラーの種類と発生箇所の要約）

## 原因箇所
`ファイルパス:行番号`
- 問題のコードと説明

## 発生条件
- どのような条件で発生するか
- 再現に必要な状態

## 修正案
```rust
// Before
問題のコード

// After
修正後のコード
```

## 根本原因
（なぜこのバグが入り込んだか）

## 再発防止
- 同様のパターンを防ぐための提案
- テストの追加案
- 静的解析ルールの追加案

## 関連調査
- 同様のパターンが存在する他の箇所
```

---

## エラーパターン別の調査ポイント

### NullPointer / None / undefined
- 変数の初期化漏れ
- 非同期処理の競合
- 条件分岐の漏れ

### Index out of bounds
- 空配列のチェック漏れ
- off-by-oneエラー
- 並行アクセスによる状態変化

### Connection refused / Timeout
- 接続先の設定ミス
- リソース枯渇
- ネットワーク設定

### Permission denied
- 権限設定
- ファイルパス
- 認証状態

### Parse error / Serialization error
- 入力データの形式
- スキーマの不一致
- エンコーディング

---

## 情報が不足している場合

以下を追加で依頼する：

1. 完全なスタックトレース
2. 発生時の入力データ（機密情報を除く）
3. 直前の操作・リクエスト
4. 環境情報（OS、ランタイムバージョン等）
5. 最近のコード変更
