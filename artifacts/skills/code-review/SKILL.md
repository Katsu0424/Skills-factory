---
name: code-review
description: |
  コミット前のコードレビューを実施し、問題点・改善案を提示する。
  「レビューして」「コードレビュー」「チェックして」などと言われた時に使用。
  ルール準拠、実装品質、セキュリティ、エラーハンドリング、パフォーマンス、可読性、テストの観点でチェック。
allowed-tools: Read, Write, Edit, Grep, Glob, Bash(git diff), Bash(git status), AskUserQuestion
---

# コードレビュースキル

## 呼び出し方
会話で「レビューして」「コードレビュー」「チェックして」等

## 目的
commit前にコードレビューを実施し、問題点・改善案を提示

---

## レビュー観点

### 1. ルール準拠チェック
- `.claude/rules/` 配下のルールに違反していないか
- プロジェクト固有の規約（命名、構造、パターン）に沿っているか
- CLAUDE.md に記載の制約を守っているか

### 2. 実装品質
- より良い実装方法がないか（言語のイディオム、標準ライブラリ活用）
- 冗長なコードがないか
- 適切な抽象化がされているか
- 責務の分離ができているか（単一責任原則）
- エッジケースの考慮漏れがないか

### 3. セキュリティ
- SQLインジェクション、XSS等の脆弱性
- ハードコードされたシークレット
- 入力値の未検証
- 認証・認可の漏れ

### 4. エラーハンドリング
- `unwrap()` / `expect()` の不適切な使用
- パニックの可能性がある箇所
- エラーの握りつぶし
- 適切なエラー型の使用

### 5. パフォーマンス
- N+1クエリパターン
- 不要な `clone()` / アロケーション
- ループ内の重い処理
- 不要なデータ取得

### 6. 可読性・保守性
- 関数の長さ（50行超は警告）
- ネストの深さ（4段超は警告）
- 命名の適切さ
- コメントの過不足

### 7. テスト
- 変更部分のテストがあるか
- テストケースの網羅性（正常系・異常系・境界値）

---

## 出力形式

```markdown
## レビュー結果

### 🔴 要対応
- **src/auth.rs:42**: `unwrap()` 使用 → `ok_or_else()` に変更推奨
  ```rust
  // Before
  let user = repo.find(id).unwrap();

  // After
  let user = repo.find(id).ok_or_else(|| AppError::NotFound(id))?;
  ```

### 🟡 検討推奨
- **src/service.rs:78-92**: ループ内でDB接続
  → バッチ処理に変更でN+1解消

### 💡 改善提案
- **src/handler.rs:15**: この関数、`user_service` に移動すると責務が明確に
- **src/model.rs:30**: `From` トレイト実装で変換が簡潔に

### ✅ Good
- エラーハンドリングが適切
- テストカバレッジ十分
```

---

## 実行手順

1. `git diff` でステージング済み・未ステージングの差分を取得
2. 変更されたファイルの全体コンテキストを確認
3. 各観点でレビューを実施
4. 問題点を重要度別に分類
5. 具体的な修正案とともに結果を出力

---

## 重要度の定義

| レベル | 意味 | 対応 |
|--------|------|------|
| 🔴 要対応 | バグ、セキュリティ問題、重大な設計ミス | 必ず修正 |
| 🟡 検討推奨 | パフォーマンス問題、可読性の低下 | 修正を推奨 |
| 💡 改善提案 | より良い書き方、リファクタリング案 | 任意で対応 |
| ✅ Good | 良い実装、適切な設計 | 称賛 |
