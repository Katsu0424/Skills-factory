---
name: sql-optimization
description: |
  遅いSQLクエリを分析し、改善案を提示する。
  「最適化して」「遅いんだけど」「チューニングして」などクエリを貼り付けて依頼された時に使用。
  インデックス、クエリ構造、JOIN、集計の観点で問題を検出。
allowed-tools: Read, Grep, Glob
---

# SQLクエリ最適化スキル

## 呼び出し方
会話でクエリを貼り付けて「最適化して」「遅いんだけど」「チューニングして」等

## 目的
遅いクエリとスキーマを渡すと改善案を提示

---

## 入力

- SQLクエリ（必須）
- テーブル定義（推奨）
- EXPLAIN結果（任意）
- 現在の実行時間（任意）

---

## 検出パターン

### インデックス関連

| パターン | 問題 | 改善案 |
|----------|------|--------|
| WHERE句にインデックスなし | フルスキャン | インデックス追加 |
| 複合インデックスの順序不適切 | インデックス効かない | 順序修正 |
| LIKE '%xxx' | インデックス効かない | 全文検索 or 設計見直し |
| 関数適用（WHERE YEAR(date)） | インデックス効かない | 範囲条件に書き換え |
| 暗黙の型変換 | インデックス効かない | 型を一致させる |

### クエリ構造

| パターン | 問題 | 改善案 |
|----------|------|--------|
| SELECT * | 不要データ転送 | 必要カラム明示 |
| N+1クエリ | 大量クエリ発行 | JOIN or バッチ取得 |
| 相関サブクエリ | 行ごとに実行 | JOIN に書き換え |
| OR条件の多用 | インデックス効かない | UNION or IN |
| DISTINCT の乱用 | 重いソート処理 | 設計見直し or EXISTS |
| ORDER BY + LIMIT なしの大量取得 | メモリ圧迫 | ページネーション |

### JOIN関連

| パターン | 問題 | 改善案 |
|----------|------|--------|
| 結合条件にインデックスなし | ネステッドループ | インデックス追加 |
| 不要な外部結合 | パフォーマンス低下 | 内部結合に変更 |
| 多段JOIN | 複雑・遅い | 非正規化検討 |
| 結合順序の非効率 | 中間結果が大きい | ヒント or 順序見直し |

### 集計関連

| パターン | 問題 | 改善案 |
|----------|------|--------|
| GROUP BY で大量行処理 | メモリ・CPU負荷 | 事前集計テーブル |
| HAVING での絞り込み | 集計後フィルタ | WHERE で事前絞り込み |
| COUNT(*) on 大テーブル | フルスキャン | 概算 or キャッシュ |

---

## 出力形式

```markdown
## 入力クエリ
```sql
（元のクエリ）
```

## 検出した問題

### 🔴 重大（対応必須）
- **問題名**: 説明
  - 影響: パフォーマンスへの影響
  - 該当箇所: クエリの該当部分

### 🟡 警告（対応推奨）
- **問題名**: 説明

### 💡 提案
- **改善案**: 説明

## 改善案

### インデックス追加
```sql
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_orders_user_created ON orders(user_id, created_at);
```

### クエリ書き換え
```sql
（改善後のクエリ）
```

## 効果予測
- Before: 推定実行時間/スキャン行数
- After: 推定実行時間/スキャン行数
- 改善率: 推定○○%改善

## 検証方法
```sql
EXPLAIN ANALYZE （改善後クエリ）;
```

## 補足
- 注意点やトレードオフ
- インデックス追加による書き込み性能への影響
- 代替案
```

---

## EXPLAIN結果の読み方ガイド

### MySQL

| 項目 | 注意すべき値 |
|------|--------------|
| type | ALL（フルスキャン）は要改善 |
| possible_keys | NULLはインデックス未使用 |
| rows | 大きい値は要検討 |
| Extra | Using filesort, Using temporary は要注意 |

### PostgreSQL

| 項目 | 注意すべき値 |
|------|--------------|
| Seq Scan | 大テーブルでは要改善 |
| Nested Loop | 大量行で非効率 |
| Sort | メモリ不足でディスクソート |
| actual time | 推定と実際の乖離 |

---

## 追加情報の依頼

最適な提案のために以下を追加で依頼することがある：

1. テーブルの行数（概算）
2. カーディナリティ（ユニーク値の数）
3. 現在のインデックス一覧
4. 実行頻度（1日何回程度か）
5. 許容レスポンスタイム
